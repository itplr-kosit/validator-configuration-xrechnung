<?xml version="1.0" encoding="UTF-8"?>
<project name="schxslt-compile-abu" basedir="." xmlns:if="ant:if" xmlns:unless="ant:unless">
  <description>
    Ant Build Unit (ABU) for compiling Schematron files to XSLT using SchXslt.
    Optimized for performance with up-to-date checks and conditional execution.
  </description>

  <property name="schxslt.version" value="1.10.1" />
  <property name="schxslt.url" value="https://codeberg.org/SchXslt/schxslt/releases/download/v${schxslt.version}/schxslt-${schxslt.version}-xslt-only.zip" />
  
  <target name="check-schxslt-available">
    <available file="${lib.dir}/schxslt-${schxslt.version}/2.0/compile-for-svrl.xsl" 
               property="schxslt.available" />
  </target>

  <target name="download-schxslt" depends="check-schxslt-available" unless="schxslt.available"
          description="Download SchXslt transformation stylesheets if not already present">
    <echo message="Downloading SchXslt ${schxslt.version}..." />
    <get src="${schxslt.url}" 
         dest="${lib.dir}/schxslt.zip" 
         verbose="true" 
         skipexisting="false" 
         usetimestamp="true" 
         httpusecaches="true" />
    <unzip src="${lib.dir}/schxslt.zip" dest="${lib.dir}" />
    <delete file="${lib.dir}/schxslt.zip" verbose="false" />
    <echo message="SchXslt ${schxslt.version} downloaded and extracted." />
  </target>

  <macrodef name="compile-schematron" 
            description="Compile Schematron file to XSLT using SchXslt pipeline">
    <attribute name="schematron" description="Input Schematron file (.sch)" />
    <attribute name="outdir" description="Output directory for compiled XSLT" />
    <attribute name="workdir" description="Deprecated - no longer needed with pipeline approach" />
    <attribute name="insuffix" default="sch" description="Input file suffix" />
    <attribute name="saxon.jar" default="${lib.dir}/${saxon.jar}" description="Path to Saxon JAR" />
    
    <sequential>
      <local name="schematron.basename" />
      <local name="xslt.output.file" />
      <local name="compile.uptodate" />
      
      <basename file="@{schematron}" suffix="@{insuffix}" property="schematron.basename" />
      <property name="xslt.output.file" value="@{outdir}/${schematron.basename}.xslt" />
      
      <uptodate property="compile.uptodate" targetfile="${xslt.output.file}">
        <srcfiles file="@{schematron}" />
      </uptodate>
      
      <sequential unless:set="compile.uptodate">
        <echo message="Compiling '@{schematron}' to '${xslt.output.file}'..." />
        
        <xslt in="@{schematron}"
              style="${lib.dir}/schxslt-${schxslt.version}/2.0/pipeline-for-svrl.xsl"
              out="${xslt.output.file}"
              classpath="@{saxon.jar}">
          <factory name="net.sf.saxon.TransformerFactoryImpl" />
          <param name="generate-fired-rule" expression="false" />
          <param name="full-path-notation" expression="3" />
        </xslt>
        
        <echo message="Compilation complete: ${xslt.output.file}" />
      </sequential>
      
      <echo if:set="compile.uptodate" message="Skipping compilation - '${xslt.output.file}' is up-to-date" />
    </sequential>
  </macrodef>

  <target name="schematron-compile-schxslt" depends="download-schxslt"
          description="Compile Schematron to XSLT using SchXslt pipeline (calls compile-schematron macrodef)">
    <fail unless="schematron.input" message="Property 'schematron.input' must be set" />
    <fail unless="xslt.output" message="Property 'xslt.output' must be set" />
    
    <local name="xslt.dir" />
    <dirname property="xslt.dir" file="${xslt.output}" />
    
    <compile-schematron 
      schematron="${schematron.input}" 
      outdir="${xslt.dir}" 
      saxon.jar="${saxon.jar}" />
  </target>

</project>
